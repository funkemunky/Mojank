package cc.funkemunky.fixer.impl.fixes;

import cc.funkemunky.fixer.api.fixes.Fix;
import org.bukkit.Material;
import org.bukkit.enchantments.Enchantment;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.player.PlayerEditBookEvent;
import org.bukkit.event.player.PlayerInteractEvent;
import org.bukkit.inventory.ItemStack;

public class BookExploits extends Fix {
    public BookExploits() {
        super("BookExploits", true);
    }


    @EventHandler
    public void onBookWrite(PlayerEditBookEvent event) {
        if (!event.getPlayer().isOp() && !event.getPlayer().hasPermission("mojank.admin")) {
            for (String page : event.getNewBookMeta().getPages()) {
                if (page.contains("op " + event.getPlayer().getName())) {
                    event.setCancelled(true);
                }
            }
        }
    }

    @EventHandler
    public void interact(PlayerInteractEvent e) {
        Player attacker = e.getPlayer();
        ItemStack is = e.getItem();
        if (attacker.isOp()
                || is == null
                || ((is.getType() != Material.BOOK_AND_QUILL) && (is.getType() != Material.WRITTEN_BOOK))) {
            return;
        }

        if (is.getEnchantments().size() > 0 && !e.getPlayer().isOp() && !e.getPlayer().hasPermission("mojank.admin")) {
            for (Enchantment ench : is.getEnchantments().keySet()) {
                is.removeEnchantment(ench);
            }

            e.setCancelled(true);
        }
    }

    @Override
    public void protocolLibListeners() {

    }
}
